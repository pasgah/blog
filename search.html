---
layout: default
title: جستجو
permalink: /search/
---

<h2>جستجو</h2>

<input id="search-input" type="text" placeholder="چی دنبالش می‌گردی؟" style="
  width:100%;
  max-width:400px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
">

<ul id="results" style="list-style:none; padding:0; margin-top:1.5rem;"></ul>

<script src="https://unpkg.com/lunr/lunr.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const searchInput = document.getElementById("search-input");
  const resultsEl = document.getElementById("results");

  let idx = null;          // ایندکس Lunr
  let documents = [];      // داده‌های کامل پست‌ها
  let ready = false;       // جلوگیری از اجرای جستجو قبل از آماده شدن

  /* ============================
     مرحله ۱: لود کردن search.json
  ============================ */
  fetch("{{ '/search.json' | relative_url }}")
    .then(r => r.json())
    .then(data => {
      documents = data;

      /* ============================
         مرحله ۲: ساخت ایندکس Lunr
      ============================ */
      idx = lunr(function () {
        this.ref("url");
        this.field("title", { boost: 10 });
        this.field("content");
        this.field("tags", { boost: 5 });
        this.field("categories", { boost: 5 });

        data.forEach(doc => this.add(doc));
      });

      ready = true; // جستجو آماده است
    })
    .catch(err => {
      console.error("خطا در لود search.json:", err);
      resultsEl.innerHTML = "<li>خطا در بارگذاری داده‌های جستجو.</li>";
    });

  /* ============================
     مرحله ۳: اجرای جستجو
  ============================ */
  searchInput.addEventListener("input", function () {
    const q = this.value.trim();
    resultsEl.innerHTML = "";

    if (!q) return;
    if (!ready) {
      resultsEl.innerHTML = "<li>در حال آماده‌سازی جستجو...</li>";
      return;
    }

    let results;
    try {
      results = idx.search(q);
    } catch (err) {
      resultsEl.innerHTML = "<li>عبارت جستجو نامعتبر است.</li>";
      return;
    }

    if (!results.length) {
      resultsEl.innerHTML = "<li>چیزی پیدا نشد.</li>";
      return;
    }

    results.forEach(r => {
      const doc = documents.find(d => d.url === r.ref);
      if (!doc) return;

      const li = document.createElement("li");
      li.style.marginBottom = "1rem";
      li.innerHTML = `
        <a href="${doc.url}">${doc.title}</a>
        <p style="opacity:0.7; margin:0.3rem 0;">
          ${doc.content.slice(0, 140)}...
        </p>
      `;
      resultsEl.appendChild(li);
    });
  });

});
</script>
